<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KitchenSinkController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample-spring-boot-kitchensink</a> &gt; <a href="index.source.html" class="el_package">com.example.bot.spring</a> &gt; <span class="el_source">KitchenSinkController.java</span></div><h1>KitchenSinkController.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2016 LINE Corporation
 *
 * LINE Corporation licenses this file to you under the Apache License,
 * version 2.0 (the &quot;License&quot;); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at:
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations
 * under the License.
 */

package com.example.bot.spring;

import java.io.IOException;
import java.io.OutputStream;
import java.io.UncheckedIOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.concurrent.ExecutionException;
import java.util.function.Consumer;
import java.util.concurrent.CompletableFuture;
import java.util.function.BiConsumer;
import com.linecorp.bot.model.profile.UserProfileResponse;
import java.util.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.servlet.support.ServletUriComponentsBuilder;

import com.google.common.io.ByteStreams;

import com.linecorp.bot.client.LineMessagingClient;
import com.linecorp.bot.client.MessageContentResponse;
import com.linecorp.bot.model.PushMessage;
import com.linecorp.bot.model.Multicast;
import com.linecorp.bot.model.ReplyMessage;
import com.linecorp.bot.model.action.MessageAction;
import com.linecorp.bot.model.action.PostbackAction;
import com.linecorp.bot.model.action.URIAction;
import com.linecorp.bot.model.event.BeaconEvent;
import com.linecorp.bot.model.event.Event;
import com.linecorp.bot.model.event.FollowEvent;
import com.linecorp.bot.model.event.JoinEvent;
import com.linecorp.bot.model.event.MessageEvent;
import com.linecorp.bot.model.event.PostbackEvent;
import com.linecorp.bot.model.event.UnfollowEvent;
import com.linecorp.bot.model.event.message.AudioMessageContent;
import com.linecorp.bot.model.event.message.ImageMessageContent;
import com.linecorp.bot.model.event.message.LocationMessageContent;
import com.linecorp.bot.model.event.message.StickerMessageContent;
import com.linecorp.bot.model.event.message.TextMessageContent;
import com.linecorp.bot.model.event.source.GroupSource;
import com.linecorp.bot.model.event.source.RoomSource;
import com.linecorp.bot.model.event.source.Source;
import com.linecorp.bot.model.message.AudioMessage;
import com.linecorp.bot.model.message.ImageMessage;
import com.linecorp.bot.model.message.ImagemapMessage;
import com.linecorp.bot.model.message.LocationMessage;
import com.linecorp.bot.model.message.Message;
import com.linecorp.bot.model.message.StickerMessage;
import com.linecorp.bot.model.message.TemplateMessage;
import com.linecorp.bot.model.message.TextMessage;
import com.linecorp.bot.model.message.imagemap.ImagemapArea;
import com.linecorp.bot.model.message.imagemap.ImagemapBaseSize;
import com.linecorp.bot.model.message.imagemap.MessageImagemapAction;
import com.linecorp.bot.model.message.imagemap.URIImagemapAction;
import com.linecorp.bot.model.message.template.ButtonsTemplate;
import com.linecorp.bot.model.message.template.CarouselColumn;
import com.linecorp.bot.model.message.template.CarouselTemplate;
import com.linecorp.bot.model.message.template.ConfirmTemplate;
import com.linecorp.bot.model.response.BotApiResponse;
import com.linecorp.bot.spring.boot.annotation.EventMapping;
import com.linecorp.bot.spring.boot.annotation.LineMessageHandler;
import java.util.stream.Collectors;
import lombok.NonNull;
import lombok.Value;
import lombok.extern.slf4j.Slf4j;

import java.net.URI;
import java.net.URISyntaxException;

<span class="fc" id="L91">@Slf4j</span>
@LineMessageHandler
public class KitchenSinkController {

	@Autowired
	public LineMessagingClient lineMessagingClient;
    public BotApiResponse apiResponse2;
    //FEATURE 5
    private String[] cacheForBooking;
<span class="fc" id="L100">    private boolean waitingForResponse = false;</span>
    public static final int WAIT_FOR_NAME = 1;
    public static final int WAIT_FOR_NUMA = 2;
    public static final int WAIT_FOR_NUMC = 3;
    public static final int WAIT_FOR_NUMT = 4;
    
	@EventMapping
	public void handleTextMessageEvent(MessageEvent&lt;TextMessageContent&gt; event) throws Exception {
<span class="nc" id="L108">		log.info(&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;);</span>
<span class="nc" id="L109">		log.info(&quot;This is your entry point:&quot;);</span>
<span class="nc" id="L110">		log.info(&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;);</span>
<span class="nc" id="L111">		TextMessageContent message = event.getMessage();</span>
<span class="nc" id="L112">		handleTextContent(event.getReplyToken(), event, message);</span>
<span class="nc" id="L113">	}</span>

	@EventMapping
	public void handleStickerMessageEvent(MessageEvent&lt;StickerMessageContent&gt; event) {
<span class="nc" id="L117">		handleSticker(event.getReplyToken(), event.getMessage());</span>
<span class="nc" id="L118">	}</span>

	@EventMapping
	public void handleLocationMessageEvent(MessageEvent&lt;LocationMessageContent&gt; event) {
<span class="nc" id="L122">		LocationMessageContent locationMessage = event.getMessage();</span>
<span class="nc" id="L123">		reply(event.getReplyToken(), new LocationMessage(locationMessage.getTitle(), locationMessage.getAddress(),</span>
<span class="nc" id="L124">				locationMessage.getLatitude(), locationMessage.getLongitude()));</span>
<span class="nc" id="L125">	}</span>

	@EventMapping
	public void handleImageMessageEvent(MessageEvent&lt;ImageMessageContent&gt; event) throws IOException {
		final MessageContentResponse response;
<span class="nc" id="L130">		String replyToken = event.getReplyToken();</span>
<span class="nc" id="L131">		String messageId = event.getMessage().getId();</span>
		try {
<span class="nc" id="L133">			response = lineMessagingClient.getMessageContent(messageId).get();</span>
<span class="nc" id="L134">		} catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L135">			reply(replyToken, new TextMessage(&quot;Cannot get image: &quot; + e.getMessage()));</span>
<span class="nc" id="L136">			throw new RuntimeException(e);</span>
<span class="nc" id="L137">		}</span>
<span class="nc" id="L138">		DownloadedContent jpg = saveContent(&quot;jpg&quot;, response);</span>
<span class="nc" id="L139">		reply(((MessageEvent) event).getReplyToken(), new ImageMessage(jpg.getUri(), jpg.getUri()));</span>

<span class="nc" id="L141">	}</span>

	@EventMapping
	public void handleAudioMessageEvent(MessageEvent&lt;AudioMessageContent&gt; event) throws IOException {
		final MessageContentResponse response;
<span class="nc" id="L146">		String replyToken = event.getReplyToken();</span>
<span class="nc" id="L147">		String messageId = event.getMessage().getId();</span>
		try {
<span class="nc" id="L149">			response = lineMessagingClient.getMessageContent(messageId).get();</span>
<span class="nc" id="L150">		} catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L151">			reply(replyToken, new TextMessage(&quot;Cannot get image: &quot; + e.getMessage()));</span>
<span class="nc" id="L152">			throw new RuntimeException(e);</span>
<span class="nc" id="L153">		}</span>
<span class="nc" id="L154">		DownloadedContent mp4 = saveContent(&quot;mp4&quot;, response);</span>
<span class="nc" id="L155">		reply(event.getReplyToken(), new AudioMessage(mp4.getUri(), 100));</span>
<span class="nc" id="L156">	}</span>

	@EventMapping
	public void handleUnfollowEvent(UnfollowEvent event) {
<span class="nc" id="L160">		log.info(&quot;unfollowed this bot: {}&quot;, event);</span>
<span class="nc" id="L161">	}</span>

	@EventMapping
	public void handleFollowEvent(FollowEvent event) {
<span class="nc" id="L165">		String replyToken = event.getReplyToken();</span>
<span class="nc" id="L166">		this.replyText(replyToken, &quot;Got followed event&quot;);</span>
<span class="nc" id="L167">	}</span>

	@EventMapping
	public void handleJoinEvent(JoinEvent event) {
<span class="nc" id="L171">		String replyToken = event.getReplyToken();</span>
<span class="nc" id="L172">		this.replyText(replyToken, &quot;Joined &quot; + event.getSource());</span>
<span class="nc" id="L173">	}</span>

	@EventMapping
	public void handlePostbackEvent(PostbackEvent event) {
<span class="nc" id="L177">		String replyToken = event.getReplyToken();</span>
<span class="nc" id="L178">		this.replyText(replyToken, &quot;Got postback &quot; + event.getPostbackContent().getData());</span>
<span class="nc" id="L179">	}</span>

	@EventMapping
	public void handleBeaconEvent(BeaconEvent event) {
<span class="nc" id="L183">		String replyToken = event.getReplyToken();</span>
<span class="nc" id="L184">		this.replyText(replyToken, &quot;Got beacon message &quot; + event.getBeacon().getHwid());</span>
<span class="nc" id="L185">	}</span>

	@EventMapping
	public void handleOtherEvent(Event event) {
<span class="nc" id="L189">		log.info(&quot;Received message(Ignored): {}&quot;, event);</span>
<span class="nc" id="L190">	}</span>

<span class="nc bnc" id="L192" title="All 4 branches missed.">	private void reply(@NonNull String replyToken, @NonNull Message message) {</span>
<span class="nc" id="L193">		reply(replyToken, Collections.singletonList(message));</span>
<span class="nc" id="L194">	}</span>

<span class="nc bnc" id="L196" title="All 4 branches missed.">	public void post(@NonNull String to, @NonNull Message message) {</span>
<span class="nc" id="L197">		postmessage(to, Collections.singletonList(message));</span>
<span class="nc" id="L198">	}</span>
	
<span class="nc bnc" id="L200" title="All 4 branches missed.">	public void Mpost(@NonNull String [] to, @NonNull Message message) {</span>
<span class="nc" id="L201">		Mpostmessage(to, Collections.singletonList(message));</span>
<span class="nc" id="L202">	}</span>
	
<span class="nc bnc" id="L204" title="All 4 branches missed.">	private void reply(@NonNull String replyToken, @NonNull List&lt;Message&gt; messages) {</span>
		try {
<span class="nc" id="L206">			BotApiResponse apiResponse = lineMessagingClient.replyMessage(new ReplyMessage(replyToken, messages)).get();</span>
<span class="nc" id="L207">			log.info(&quot;Sent messages: {}&quot;, apiResponse);</span>
<span class="nc" id="L208">		} catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L209">			throw new RuntimeException(e);</span>
<span class="nc" id="L210">		}</span>
<span class="nc" id="L211">	}</span>
	

<span class="nc bnc" id="L214" title="All 4 branches missed.">	public void postmessage(@NonNull String to, @NonNull List&lt;Message&gt; messages) {</span>
		try {
<span class="nc" id="L216">    		    apiResponse2 = lineMessagingClient.pushMessage(new PushMessage(to, messages)).get();</span>
<span class="nc" id="L217">			log.info(&quot;Sent messages: {}&quot;, apiResponse2);</span>
<span class="nc" id="L218">		} catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L219">			throw new RuntimeException(e);</span>
<span class="nc" id="L220">		}</span>
<span class="nc" id="L221">	}</span>
	

<span class="nc bnc" id="L224" title="All 4 branches missed.">	public void Mpostmessage(@NonNull String [] to, @NonNull List&lt;Message&gt; messages) {</span>
		try {
<span class="nc" id="L226">			Set&lt;String&gt; strSet = Arrays.stream(to).collect(Collectors.toSet());</span>
<span class="nc" id="L227">    		    apiResponse2 = lineMessagingClient.multicast(new Multicast(strSet, messages)).get();</span>
<span class="nc" id="L228">			log.info(&quot;Sent messages: {}&quot;, apiResponse2);</span>
<span class="nc" id="L229">		} catch (InterruptedException | ExecutionException e) {</span>
<span class="nc" id="L230">			throw new RuntimeException(e);</span>
<span class="nc" id="L231">		}</span>
<span class="nc" id="L232">	}</span>
	
	
<span class="nc bnc" id="L235" title="All 4 branches missed.">	public void postText(@NonNull String to,@NonNull String message) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">		if (message.length() &gt; 1000) {</span>
<span class="nc" id="L237">			message = message.substring(0, 1000 - 2) + &quot;..&quot;;</span>
		}
<span class="nc" id="L239">		this.post(to, new TextMessage(message));</span>
<span class="nc" id="L240">	}</span>
	
<span class="nc bnc" id="L242" title="All 4 branches missed.">	public void MpostText(@NonNull String [] to,@NonNull String message) {</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">		if (message.length() &gt; 1000) {</span>
<span class="nc" id="L244">			message = message.substring(0, 1000 - 2) + &quot;..&quot;;</span>
		}
<span class="nc" id="L246">		this.Mpost(to, new TextMessage(message));</span>
<span class="nc" id="L247">	}</span>
	
<span class="nc bnc" id="L249" title="All 4 branches missed.">	private void replyText(@NonNull String replyToken, @NonNull String message) {</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">		if (replyToken.isEmpty()) {</span>
<span class="nc" id="L251">			throw new IllegalArgumentException(&quot;replyToken must not be empty&quot;);</span>
		}
<span class="nc bnc" id="L253" title="All 2 branches missed.">		if (message.length() &gt; 10000) {</span>
<span class="nc" id="L254">			message = message.substring(0, 10000 - 2) + &quot;..&quot;;</span>
		}
<span class="nc" id="L256">		this.reply(replyToken, new TextMessage(message));</span>
<span class="nc" id="L257">	}</span>


	private void handleSticker(String replyToken, StickerMessageContent content) {
<span class="nc" id="L261">		reply(replyToken, new StickerMessage(content.getPackageId(), content.getStickerId()));</span>
<span class="nc" id="L262">	}</span>

	public void handleTextContent(String replyToken, Event event, TextMessageContent content)
            throws Exception {
<span class="nc" id="L266">        String text = content.getText();</span>

<span class="nc" id="L268">        log.info(&quot;Got text message from {}: {}&quot;, replyToken, text);</span>
<span class="nc bnc" id="L269" title="All 30 branches missed.">        switch (text) {</span>
	        
//        	case &quot;hi&quot;:
//        	case &quot;hey&quot;:
//        	case &quot;hello&quot;:
//        	{
//        		
//        		break;
//        	}
        
        	case &quot;profile&quot;: {
<span class="nc" id="L280">                String userId = event.getSource().getUserId();</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">                if (userId != null) {</span>
<span class="nc" id="L282">                    lineMessagingClient</span>
<span class="nc" id="L283">                            .getProfile(userId)</span>
<span class="nc" id="L284">                            .whenComplete(new ProfileGetter (this, replyToken));</span>
                } else {
<span class="nc" id="L286">                    this.replyText(replyToken, &quot;Bot can't use profile API without user ID&quot;);</span>
                }
<span class="nc" id="L288">                break;</span>
            }
            case &quot;confirm&quot;: {
<span class="nc" id="L291">                ConfirmTemplate confirmTemplate = new ConfirmTemplate(</span>
                        &quot;Do it?&quot;,
                        new MessageAction(&quot;Yes&quot;, &quot;Yes!&quot;),
                        new MessageAction(&quot;No&quot;, &quot;No!&quot;)
                );
<span class="nc" id="L296">                TemplateMessage templateMessage = new TemplateMessage(&quot;Confirm alt text&quot;, confirmTemplate);</span>
<span class="nc" id="L297">                this.reply(replyToken, templateMessage);</span>
<span class="nc" id="L298">                break;</span>
            }
            
            case &quot;adminupdate&quot;:{
<span class="nc" id="L302">            	 StatusName status = new StatusName(&quot;tripB&quot;);</span>
<span class="nc" id="L303">                 status.notAllConfirmed();</span>
<span class="nc" id="L304">                 List&lt;Tourist&gt; touristlist = status.getConfirmedTourist();</span>
<span class="nc" id="L305">                 List&lt;String&gt;  sizestring  = status.getStringSize();</span>
<span class="nc" id="L306">                 List&lt;String&gt;  failstring  = status.getFailSize();</span>
<span class="nc" id="L307">                 List&lt;String&gt;  nmc         = status.getNEConfirmed();</span>
<span class="nc" id="L308">                 List&lt;String&gt;  nmcc         = status.getNEConfirmedN();</span>
                 //enough number of tourmates
<span class="nc bnc" id="L310" title="All 2 branches missed.">                 for(int i = 0; i &lt; sizestring.size() ; i++)</span>
<span class="nc" id="L311">                 this.postText(event.getSource().getUserId(), &quot;Hi,&quot;+sizestring.get(i)+&quot;,I am going to updated your trip status : &quot; +&quot;Success. Your team 's your guide is Mr. Sung. He 'll contact you at soon. Have a nice trip ^^ &quot;);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">                 for(int i = 0 ; i &lt; failstring.size() ; i++) {</span>
<span class="nc" id="L313">                 this.postText(event.getSource().getUserId(), &quot;Hi,&quot;+failstring.get(i)+&quot;,I am going to updated your trip status : \n&quot; +&quot;We 're fail to offer you a trip due to unsufficient trip fee you pay. \n&quot; + &quot; You have 2 choices for your trip.\n 1) Pay tour fee before today 6:00 pm \n 2) Cancel tour booking. \n Please contact us at soon.&quot;);</span>
                 }
                 //failure number of tourmates
<span class="nc bnc" id="L316" title="All 2 branches missed.">                 for(int i = 0 ; i &lt; nmc.size() ; i++)</span>
<span class="nc" id="L317">                	 this.postText(event.getSource().getUserId(), &quot;Hi,&quot;+nmc.get(i)+&quot;,I am going to updated your trip status : &quot; +&quot;Failure since not enough number of person which give full fee join the trip&quot;);</span>
<span class="nc bnc" id="L318" title="All 2 branches missed.">                 for(int i = 0 ; i &lt; nmcc.size() ; i++)</span>
<span class="nc" id="L319">                	 this.postText(event.getSource().getUserId(), &quot;Hi,&quot;+nmcc.get(i)+&quot;,I am going to updated your trip status : &quot; +&quot;Failure since not enough number of person which give full fee join the trip and also you didn 't give sufficient money for trip.&quot;);</span>
                 
<span class="nc" id="L321">            	break;</span>
            }
            case &quot;carousel&quot;: {
<span class="nc" id="L324">                String imageUrl = createUri(&quot;/static/buttons/1040.jpg&quot;);</span>
<span class="nc" id="L325">                CarouselTemplate carouselTemplate = new CarouselTemplate(</span>
<span class="nc" id="L326">                        Arrays.asList(</span>
<span class="nc" id="L327">                                new CarouselColumn(imageUrl, &quot;hoge&quot;, &quot;fuga&quot;, Arrays.asList(</span>
                                        new URIAction(&quot;Go to line.me&quot;,
                                                      &quot;https://line.me&quot;),
                                        new PostbackAction(&quot;Say hello1&quot;,
                                                           &quot;hello 嚙踝蕭��嚙踐����蕭��������蕭��嚙踝蕭謕蕭�摰�郭嚙踐�蕭�蝮�郭嚙踐�蕭��&quot;)
                                )),
<span class="nc" id="L333">                                new CarouselColumn(imageUrl, &quot;hoge&quot;, &quot;fuga&quot;, Arrays.asList(</span>
                                        new PostbackAction(&quot;嚙踐���頩蕭 hello2&quot;,
                                                           &quot;hello 嚙踝蕭��嚙踐����蕭��������蕭��嚙踝蕭謕蕭�摰�郭嚙踐�蕭�蝮�郭嚙踐�蕭��&quot;,
                                                           &quot;hello 嚙踝蕭��嚙踐����蕭��������蕭��嚙踝蕭謕蕭�摰�郭嚙踐�蕭�蝮�郭嚙踐�蕭��&quot;),
                                        new MessageAction(&quot;Say message&quot;,
                                                          &quot;Rice=嚙踝蕭賹��蕭&quot;)
                                ))
                        ));
<span class="nc" id="L341">                TemplateMessage templateMessage = new TemplateMessage(&quot;Carousel alt text&quot;, carouselTemplate);</span>
<span class="nc" id="L342">                this.reply(replyToken, templateMessage);</span>
<span class="nc" id="L343">                break;</span>
            }
            
            /**
             * Feature 2a: FAQ Section
             * - The gathering point shall be shown to the client, presented by a picture and description.
             */
            case &quot;search assembly point&quot;: {
<span class="nc" id="L351">                String imageUrl = createUri(&quot;/static/gather.jpg&quot;);</span>
<span class="nc" id="L352">                CarouselTemplate carouselTemplate = new CarouselTemplate(</span>
<span class="nc" id="L353">                        Arrays.asList(</span>
<span class="nc" id="L354">                                new CarouselColumn(imageUrl, &quot;Assembly Point&quot;, &quot; &quot;, Arrays.asList(</span>
<span class="nc" id="L355">                                        new PostbackAction(&quot;Get more information&quot;, database.search(text,&quot;twchiuaa&quot;))</span>
                                ))
                        ));
<span class="nc" id="L358">                TemplateMessage templateMessage = new TemplateMessage(&quot;Carousel alt text&quot;, carouselTemplate);</span>
<span class="nc" id="L359">                this.reply(replyToken, templateMessage);</span>
<span class="nc" id="L360">                break;</span>
            }
            case &quot;command: confirmed&quot;: {
<span class="nc bnc" id="L363" title="All 2 branches missed.">            		if(cacheForBooking != null)</span>
            		{
<span class="nc" id="L365">            			String userId = event.getSource().getUserId();</span>
<span class="nc" id="L366">                		String responseFromDB = database.booking(cacheForBooking, userId);</span>
                		//responseFromDB += &quot;You should paid your price before 3 days the trip established.&quot;;
<span class="nc" id="L368">                		cacheForBooking = null;</span>
<span class="nc" id="L369">                		this.replyText(replyToken, responseFromDB);</span>
<span class="nc" id="L370">            		}</span>
            		else
            		{
<span class="nc" id="L373">            			this.replyText(replyToken, &quot;You have already booked that tour!&quot;);</span>
            		}

<span class="nc" id="L376">            		break;</span>
            }
            case &quot;command: cancelled&quot;: {
<span class="nc bnc" id="L379" title="All 2 branches missed.">            		if(cacheForBooking != null)</span>
            		{
<span class="nc" id="L381">            			cacheForBooking = null;</span>
<span class="nc" id="L382">                		this.replyText(replyToken, &quot;Booking Cancelled&quot;);</span>
            		}
            		else
            		{
<span class="nc" id="L386">            			this.replyText(replyToken, &quot;You have already cancelled the booking!&quot;);</span>
            		}

<span class="nc" id="L389">            		break;</span>
            }

            default:
            	
            	//Run API function
<span class="nc" id="L395">           	 String[] parts = text.split(&quot;:&quot;);</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">           	 if(parts[0].equals(&quot;adminupdate&quot;) ) {</span>
<span class="nc" id="L397">           	 StatusName status = new StatusName(parts[1]);</span>
<span class="nc" id="L398">                status.notAllConfirmed();</span>
<span class="nc" id="L399">                List&lt;Tourist&gt; touristlist = status.getConfirmedTourist();</span>
<span class="nc" id="L400">                List&lt;String&gt;  sizestring  = status.getStringSize();</span>
<span class="nc" id="L401">                List&lt;String&gt;  failstring  = status.getFailSize();</span>
<span class="nc" id="L402">                List&lt;String&gt;  nmc         = status.getNEConfirmed();</span>
<span class="nc" id="L403">                List&lt;String&gt;  nmcc        = status.getNEConfirmedN();</span>
<span class="nc" id="L404">                List&lt;String&gt;  ccid        = status.getccid();</span>
<span class="nc" id="L405">                List&lt;String&gt;  testid      = status.getestid();</span>
<span class="nc" id="L406">                List&lt;String&gt;  testid2      = status.getestid2();</span>
<span class="nc" id="L407">                List&lt;String&gt;  ccidn       = status.getccidn();</span>
<span class="nc" id="L408">                List&lt;String&gt;  nccid       = status.getnccid();</span>
<span class="nc" id="L409">                List&lt;String&gt;  nccidn      = status.getnccidn();</span>
                //enough number of tourmates
                //&quot;U53250c5aaa0ebc147a426e384e5d751c&quot;
                
<span class="nc" id="L413">                String[] idget = null;</span>
<span class="nc" id="L414">                String [] idget2  = null;</span>
<span class="nc" id="L415">                String [] idget3  = null;</span>
<span class="nc" id="L416">                String [] idget4 = null;</span>
<span class="nc" id="L417">                idget = testid.toArray(new String[testid.size()]);</span>
<span class="nc" id="L418">                idget2  =  testid2.toArray(new String[testid2.size()]);</span>
<span class="nc" id="L419">                idget3  =  nccid.toArray(new String[nccid.size()]);</span>
<span class="nc" id="L420">                idget4  =  nccid.toArray(new String[nccidn.size()]);</span>
                
<span class="nc" id="L422">                this.MpostText(idget, &quot;Hi,I am going to updated your trip status : &quot; +&quot;Success. Your team 's your guide is Mr. Sung. He 'll contact you at soon. Have a nice trip ^^ &quot;);</span>
<span class="nc" id="L423">                this.MpostText(idget2, &quot;Hi, I am going to updated your trip statusI am going to updated your trip status : We 're fail to offer you a trip due to unsufficient trip fee you pay. \n You have 2 choices for your trip.\n 1) Pay tour fee before today 6:00 pm \n 2) Cancel tour booking. \n Please contact us at soon.&quot;);</span>
<span class="nc" id="L424">                this.MpostText(idget3, &quot;Hi,I am going to updated your trip status : Failure since not enough number of person which give full fee join the trip&quot;);</span>
<span class="nc" id="L425">                this.MpostText(idget4, &quot;Hi,I am goign to updated your trip status : ailure since not enough number of person which give full fee join the trip and also you didn 't give sufficient money for trip.&quot;);</span>

                
                //for(int i = 0; i &lt; sizestring.size() ; i++)
                //this.postText(ccid.get(i), &quot;Hi,&quot;+sizestring.get(i)+&quot;,I am going to updated your trip status : &quot; +&quot;Success. Your team 's your guide is Mr. Sung. He 'll contact you at soon. Have a nice trip ^^ &quot;);
                //for(int i = 0 ; i &lt; failstring.size() ; i++) {
                //this.postText(ccid.get(i), &quot;Hi,&quot;+failstring.get(i)+&quot;,I am going to updated your trip status : \n&quot; +&quot;We 're fail to offer you a trip due to unsufficient trip fee you pay. \n&quot; + &quot; You have 2 choices for your trip.\n 1) Pay tour fee before today 6:00 pm \n 2) Cancel tour booking. \n Please contact us at soon.&quot;);
                //}
                //failure number of tourmates
                //for(int i = 0 ; i &lt; nmc.size() ; i++)
                //this.postText(ccid.get(i), &quot;Hi,&quot;+nmc.get(i)+&quot;,I am going to updated your trip status : &quot; +&quot;Failure since not enough number of person which give full fee join the trip&quot;);
                //for(int i = 0 ; i &lt; nmcc.size() ; i++)
               //this.postText(ccid.get(i), &quot;Hi,&quot;+nmcc.get(i)+&quot;,I am going to updated your trip status : &quot; +&quot;Failure since not enough number of person which give full fee join the trip and also you didn 't give sufficient money for trip.&quot;);
<span class="nc" id="L438">           	 } else {</span>
<span class="nc" id="L439">            	String reply = null;       	</span>
            	try {
            		
<span class="nc bnc" id="L442" title="All 2 branches missed.">            		 if (waitingForResponse == true) {</span>
                 		
<span class="nc" id="L444">                 		String userId = event.getSource().getUserId();</span>
                 		
<span class="nc bnc" id="L446" title="All 5 branches missed.">                 		switch (database.getConversationStatus(userId))</span>
                 		{
                 		case WAIT_FOR_NAME: {
<span class="nc" id="L449">                 			database.updateClientName(userId, text);</span>
<span class="nc" id="L450">                 			cacheForBooking[2] = text;</span>
                 			
<span class="nc" id="L452">             				String askNumAdult = &quot;How many adult?&quot;;</span>
<span class="nc" id="L453">             				this.replyText(replyToken, askNumAdult);</span>
<span class="nc" id="L454">             				waitingForResponse = true;</span>
<span class="nc" id="L455">             				database.setConversationStatus(userId, WAIT_FOR_NUMA);</span>
<span class="nc" id="L456">                 			break;</span>
                 		}
                 		case WAIT_FOR_NUMA: {
<span class="nc" id="L459">                 			cacheForBooking[3] = text;</span>
                 			
<span class="nc" id="L461">                 			String askNumChildren = &quot;How many children?&quot;;</span>
<span class="nc" id="L462">                 			this.replyText(replyToken, askNumChildren);</span>
<span class="nc" id="L463">                 			waitingForResponse = true;</span>
<span class="nc" id="L464">                 			database.setConversationStatus(userId, WAIT_FOR_NUMC);</span>
<span class="nc" id="L465">                 			break;</span>
                 		}
                 		case WAIT_FOR_NUMC: {
<span class="nc" id="L468">                 			cacheForBooking[4] = text;</span>
                 			
<span class="nc" id="L470">                 			String askNumToddler = &quot;How many toddler&quot;;</span>
<span class="nc" id="L471">                 			this.replyText(replyToken, askNumToddler);</span>
<span class="nc" id="L472">                 			waitingForResponse = true;</span>
<span class="nc" id="L473">                 			database.setConversationStatus(userId, WAIT_FOR_NUMT);</span>
<span class="nc" id="L474">                 			break;</span>
                 		}
                 		case WAIT_FOR_NUMT: {
<span class="nc" id="L477">                 			cacheForBooking[5] = text;</span>
                 			
<span class="nc" id="L479">                 			confirmBooking(replyToken);</span>
<span class="nc" id="L480">                 			waitingForResponse = false;</span>
<span class="nc" id="L481">                 			database.setConversationStatus(userId, 0);</span>
<span class="nc" id="L482">                 			break;</span>
                 		}
                 		default:
<span class="nc" id="L485">                     		waitingForResponse = false;</span>
                 			break;
                 		}
                 		
                 		//return;
                 }
            		//Feature 5: collect user info when booking tour
<span class="nc bnc" id="L492" title="All 2 branches missed.">            		if(text.contains(&quot;book&quot;))</span>
            		{
            			
            			//

<span class="nc" id="L497">            			cacheForBooking = new String[6];</span>
<span class="nc" id="L498">            			String[] bookingInfo = text.split(&quot;:&quot;);</span>
<span class="nc" id="L499">            			cacheForBooking[1] = bookingInfo[1];</span>
            			
<span class="nc" id="L501">            			String userId = event.getSource().getUserId();</span>
            			
<span class="nc bnc" id="L503" title="All 2 branches missed.">            			if(database.checkClient(userId)) {</span>
<span class="nc" id="L504">            				String askNumAdult = &quot;How many adult?&quot;;</span>
<span class="nc" id="L505">            				this.replyText(replyToken, askNumAdult);</span>
<span class="nc" id="L506">            				waitingForResponse = true;</span>
<span class="nc" id="L507">            				database.setConversationStatus(userId, WAIT_FOR_NUMA);</span>
<span class="nc" id="L508">            			}</span>
            			else
            			{
<span class="nc" id="L511">            				database.addClient(userId);</span>
            				
<span class="nc" id="L513">            				String newCustomerGreeting = &quot;Hello, new customer. What should I call you?&quot;;</span>
<span class="nc" id="L514">            				this.replyText(replyToken, newCustomerGreeting);</span>
<span class="nc" id="L515">            				waitingForResponse = true;</span>
<span class="nc" id="L516">            				database.setConversationStatus(userId, WAIT_FOR_NAME);</span>
            			}
            		
            		}
            		
<span class="nc" id="L521">            		reply = database.switchFunctions(text,event.getSource().getUserId());</span>
//            		reply = database.searchByKeywords(text);
//            		reply = database.search(text,event.getSource().getUserId());
            		
<span class="nc" id="L525">            	} catch (Exception e) {</span>
<span class="nc" id="L526">            		reply = text;</span>
<span class="nc" id="L527">            	}</span>
<span class="nc" id="L528">                log.info(&quot;Returns echo message {}: {}&quot;, replyToken, reply);</span>
<span class="nc" id="L529">                this.replyText(</span>
                        replyToken,
//                        itscLOGIN + &quot; says &quot; + reply
                		reply
                );
                // PUSH Message API and use
           	 }
                break;
                
        }
<span class="nc" id="L539">    }</span>
	
	private String confirmBooking(String replyToken) throws Exception {
<span class="nc" id="L542">		String result = null;</span>
		
		try {
<span class="nc" id="L545">			String displayString = &quot;&quot;;</span>
			
<span class="nc bnc" id="L547" title="All 2 branches missed.">			if(cacheForBooking.length != 6)</span>
			{
<span class="nc" id="L549">				result = &quot;Error Occur: Booking Information not correct. Please retry or contact our staff&quot;;</span>
<span class="nc" id="L550">				this.replyText(replyToken, result);</span>
			}
		
<span class="nc bnc" id="L553" title="All 2 branches missed.">			if(database.checkTour(cacheForBooking[1]))</span>
			{
				
<span class="nc" id="L556">				displayString += &quot;Please confirm the following booking: \n&quot;;</span>

<span class="nc" id="L558">				displayString += &quot;Tour Name: &quot; + cacheForBooking[1] + &quot;\n&quot;;</span>
<span class="nc" id="L559">				displayString += &quot;Customer Name: &quot; + cacheForBooking[2] + &quot;\n&quot;;</span>
<span class="nc" id="L560">				displayString += &quot;Number Of Adult: &quot; + cacheForBooking[3] + &quot;\n&quot;;</span>
<span class="nc" id="L561">				displayString += &quot;Number Of Child: &quot; + cacheForBooking[4] + &quot;\n&quot;;</span>
<span class="nc" id="L562">				displayString += &quot;Number Of Toodler: &quot; + cacheForBooking[5] + &quot;\n&quot;;</span>
			

<span class="nc" id="L565">				ConfirmTemplate confirmTemplate = new ConfirmTemplate(</span>
						displayString,
						new MessageAction(&quot;Yes&quot;, &quot;command: confirmed&quot;),
						new MessageAction(&quot;No&quot;, &quot;command: cancelled&quot;)
						);
<span class="nc" id="L570">				TemplateMessage templateMessage = new TemplateMessage(&quot;Confirm alt text&quot;, confirmTemplate);</span>
				

				
				//System.out.println(&quot;The price is &quot;+ price);
				
<span class="nc" id="L576">				this.reply(replyToken, templateMessage);</span>
<span class="nc" id="L577">			}</span>
			else
			{
<span class="nc" id="L580">				result = &quot;There is no tour named: &quot; + cacheForBooking[1];</span>
<span class="nc" id="L581">				this.replyText(replyToken, result);</span>
			}

        //result = templateMessage.toString();
        
<span class="nc" id="L586">			return result;</span>
		}
<span class="nc" id="L588">		catch (Exception e) {</span>
<span class="nc" id="L589">			return result = &quot;can not recognize the command&quot;;</span>
     	}
	}
	
	
	public String bookingTour(String replyToken, String[] bookingDetails) throws Exception {
<span class="nc" id="L595">		String result = null;</span>
		
		try {
<span class="nc" id="L598">			String displayString = &quot;&quot;;</span>
			
<span class="nc bnc" id="L600" title="All 2 branches missed.">			if(bookingDetails.length != 6)</span>
			{
<span class="nc" id="L602">				result = &quot;Please follow the booking template: (book,TripName,YourName,NumOfAdult,NumOfChild,NumOfToddler)&quot;;</span>
<span class="nc" id="L603">				this.replyText(replyToken, result);</span>
			}
		
<span class="nc bnc" id="L606" title="All 2 branches missed.">			if(database.checkTour(bookingDetails[1]))</span>
			{
				
<span class="nc" id="L609">				displayString += &quot;Please confirm the following booking: \n&quot;;</span>
<span class="nc" id="L610">				displayString += &quot;Tour Name: &quot; + bookingDetails[1] + &quot;\n&quot;;</span>
<span class="nc" id="L611">				displayString += &quot;Customer Name: &quot; + bookingDetails[2] + &quot;\n&quot;;</span>
<span class="nc" id="L612">				displayString += &quot;Number Of Adult: &quot; + bookingDetails[3] + &quot;\n&quot;;</span>
<span class="nc" id="L613">				displayString += &quot;Number Of Child: &quot; + bookingDetails[4] + &quot;\n&quot;;</span>
<span class="nc" id="L614">				displayString += &quot;Number Of Toodler: &quot; + bookingDetails[5] + &quot;\n&quot;;</span>
				//displayString += &quot;Price you should paid: &quot; + Integer.toString(price) + &quot;\n&quot;;
<span class="nc" id="L616">				ConfirmTemplate confirmTemplate = new ConfirmTemplate(</span>
						displayString,
						new MessageAction(&quot;Yes&quot;, &quot;command: confirmed&quot;),
						new MessageAction(&quot;No&quot;, &quot;command: cancelled&quot;)
						);
<span class="nc" id="L621">				TemplateMessage templateMessage = new TemplateMessage(&quot;Confirm alt text&quot;, confirmTemplate);</span>
				
<span class="nc" id="L623">				cacheForBooking = new String[bookingDetails.length];</span>
				
<span class="nc bnc" id="L625" title="All 2 branches missed.">				for(int i=0; i&lt;bookingDetails.length; i++)</span>
				{
<span class="nc" id="L627">					cacheForBooking[i] = bookingDetails[i];</span>
				}
				
				//System.out.println(&quot;The price is &quot;+ price);
				
<span class="nc" id="L632">				this.reply(replyToken, templateMessage);</span>
<span class="nc" id="L633">			}</span>
			else
			{
<span class="nc" id="L636">				result = &quot;There is no tour named: &quot; + bookingDetails[1];</span>
<span class="nc" id="L637">				this.replyText(replyToken, result);</span>
			}

        //result = templateMessage.toString();
        
<span class="nc" id="L642">			return result;</span>
		}
<span class="nc" id="L644">		catch (Exception e) {</span>
<span class="nc" id="L645">			return result = &quot;can not recognize the command&quot;;</span>
     	}
	}

	private Connection getConnection() throws URISyntaxException, SQLException {
		Connection connection;
<span class="nc" id="L651">		URI dbUri = new URI(&quot;postgres://itniqlvmjieeeq:1bf7632721043bf02f0f498974ece3939ed3e947b9c96435ca0ced9d06593f33@ec2-107-22-235-167.compute-1.amazonaws.com:5432/daj5i9364g5dfv&quot;);</span>
<span class="nc" id="L652">		String username = dbUri.getUserInfo().split(&quot;:&quot;)[0];</span>
<span class="nc" id="L653">		String password = dbUri.getUserInfo().split(&quot;:&quot;)[1];</span>
<span class="nc" id="L654">		String dbUrl = &quot;jdbc:postgresql://&quot; + dbUri.getHost() + ':' + dbUri.getPort() + dbUri.getPath() +  &quot;?ssl=true&amp;sslfactory=org.postgresql.ssl.NonValidatingFactory&quot;;</span>

<span class="nc" id="L656">		log.info(&quot;Username: {} Password: {}&quot;, username, password);</span>
<span class="nc" id="L657">		log.info (&quot;dbUrl: {}&quot;, dbUrl);</span>
		
<span class="nc" id="L659">		connection = DriverManager.getConnection(dbUrl, username, password);</span>

<span class="nc" id="L661">		return connection;</span>
	}
	
	
	static String createUri(String path) {
<span class="nc" id="L666">		return ServletUriComponentsBuilder.fromCurrentContextPath().path(path).build().toUriString();</span>
	}

	private void system(String... args) {
<span class="nc" id="L670">		ProcessBuilder processBuilder = new ProcessBuilder(args);</span>
		try {
<span class="nc" id="L672">			Process start = processBuilder.start();</span>
<span class="nc" id="L673">			int i = start.waitFor();</span>
<span class="nc" id="L674">			log.info(&quot;result: {} =&gt;  {}&quot;, Arrays.toString(args), i);</span>
<span class="nc" id="L675">		} catch (IOException e) {</span>
<span class="nc" id="L676">			throw new UncheckedIOException(e);</span>
<span class="nc" id="L677">		} catch (InterruptedException e) {</span>
<span class="nc" id="L678">			log.info(&quot;Interrupted&quot;, e);</span>
<span class="nc" id="L679">			Thread.currentThread().interrupt();</span>
<span class="nc" id="L680">		}</span>
<span class="nc" id="L681">	}</span>

	public void hehe() {
<span class="nc" id="L684">		System.out.print(123);</span>
<span class="nc" id="L685">	}</span>
	
	private static DownloadedContent saveContent(String ext, MessageContentResponse responseBody) {
<span class="nc" id="L688">		log.info(&quot;Got content-type: {}&quot;, responseBody);</span>

<span class="nc" id="L690">		DownloadedContent tempFile = createTempFile(ext);</span>
<span class="nc" id="L691">		try (OutputStream outputStream = Files.newOutputStream(tempFile.path)) {</span>
<span class="nc" id="L692">			ByteStreams.copy(responseBody.getStream(), outputStream);</span>
<span class="nc" id="L693">			log.info(&quot;Saved {}: {}&quot;, ext, tempFile);</span>
<span class="nc" id="L694">			return tempFile;</span>
<span class="nc bnc" id="L695" title="All 8 branches missed.">		} catch (IOException e) {</span>
<span class="nc" id="L696">			throw new UncheckedIOException(e);</span>
		}
	}

	private static DownloadedContent createTempFile(String ext) {
<span class="nc" id="L701">		String fileName = LocalDateTime.now().toString() + '-' + UUID.randomUUID().toString() + '.' + ext;</span>
<span class="nc" id="L702">		Path tempFile = KitchenSinkApplication.downloadedContentDir.resolve(fileName);</span>
<span class="nc" id="L703">		tempFile.toFile().deleteOnExit();</span>
<span class="nc" id="L704">		return new DownloadedContent(tempFile, createUri(&quot;/downloaded/&quot; + tempFile.getFileName()));</span>
	}


<span class="fc" id="L708">	public KitchenSinkController() {</span>
<span class="fc" id="L709">		database = new SQLDatabaseEngine();</span>
//		database = new SQLDatabaseEngine();

<span class="fc" id="L712">		itscLOGIN = System.getenv(&quot;ITSC_LOGIN&quot;);</span>
<span class="fc" id="L713">	}</span>

	private SQLDatabaseEngine database;
	private String itscLOGIN;
	

	//The annontation @Value is from the package lombok.Value
	//Basically what it does is to generate constructor and getter for the class below
	//See https://projectlombok.org/features/Value
<span class="nc bnc" id="L722" title="All 20 branches missed.">	@Value</span>
	public static class DownloadedContent {
<span class="nc" id="L724">		Path path;</span>
<span class="nc" id="L725">		String uri;</span>
	}


	//an inner class that gets the user profile and status message
	class ProfileGetter implements BiConsumer&lt;UserProfileResponse, Throwable&gt; {
		private KitchenSinkController ksc;
		private String replyToken;
		
<span class="nc" id="L734">		public ProfileGetter(KitchenSinkController ksc, String replyToken) {</span>
<span class="nc" id="L735">			this.ksc = ksc;</span>
<span class="nc" id="L736">			this.replyToken = replyToken;</span>
<span class="nc" id="L737">		}</span>
		@Override
    	public void accept(UserProfileResponse profile, Throwable throwable) {
<span class="nc bnc" id="L740" title="All 2 branches missed.">    		if (throwable != null) {</span>
<span class="nc" id="L741">            	ksc.replyText(replyToken, throwable.getMessage());</span>
<span class="nc" id="L742">            	return;</span>
        	}
<span class="nc" id="L744">        	ksc.reply(</span>
                	replyToken,
<span class="nc" id="L746">                	Arrays.asList(new TextMessage(</span>
<span class="nc" id="L747">                		&quot;Display name: &quot; + profile.getDisplayName()),</span>
                              	new TextMessage(&quot;Status message: &quot;
<span class="nc" id="L749">                            		  + profile.getStatusMessage()))</span>
        	);
<span class="nc" id="L751">    	}</span>
		

		
		
    }
	
	

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>